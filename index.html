<!DOCTYPE html>
<html lang="en">
<head>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9192881851025175"
     crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somiti Management - Free Software</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for HTML to image conversion -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .hidden {
            display: none !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(79, 70, 229, 0.3);
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .error-message {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .success-message {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            color: #166534;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .action-btn {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .member-row {
            transition: all 0.3s ease;
        }
        .member-row:hover {
            background-color: #f8fafc;
        }
        .transaction-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 12px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .payment-transaction {
            border-left-color: #10B981;
        }
        .expense-transaction {
            border-left-color: #EF4444;
        }
        .advance-transaction {
            border-left-color: #3B82F6;
        }
        
        /* Print styles for PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            .glass-effect {
                background: white !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            .btn-primary, .action-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-700">üí∞ Somiti Manager</h1>
                </div>
                <div id="authButtons" class="flex space-x-3">
                    <button onclick="showLogin()" class="btn-primary">Login</button>
                    <button onclick="showRegister()" class="bg-white text-indigo-700 border border-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition duration-300">Register</button>
                </div>
                <div id="userMenu" class="hidden">
                    <div class="flex items-center space-x-4">
                        <span id="userName" class="font-semibold text-gray-800"></span>
                        <span id="userRole" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                        <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition duration-300">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20">
        <!-- Hero Section -->
        <section id="heroSection" class="min-h-screen flex items-center justify-center px-4">
            <div class="text-center max-w-6xl mx-auto">
                <h1 class="text-5xl md:text-7xl font-bold text-black mb-6 leading-tight">
                    Committee Management 
                    <span class="text-yellow-300">Software</span>
                </h1>
                <p class="text-xl md:text-2xl text-black mb-8 opacity-90 max-w-3xl mx-auto">
                    Complete free software for managing your committee's monthly savings, expenses, and financial tracking
                </p>
                <div class="space-x-4 mb-16">
                    <button onclick="showRegister()" class="btn-primary text-lg px-10 py-5 text-xl">
                        üöÄ Start Free Trial
                    </button>
                    <button onclick="showMemberView()" class="bg-white text-indigo-700 px-10 py-5 rounded-lg font-semibold text-xl hover:bg-gray-100 transition duration-300">
                        üë• Member View
                    </button>
                </div>
                
                <!-- Features Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
                    <div class="glass-effect rounded-xl p-6 text-center hover:shadow-xl transition duration-300">
                        <div class="text-4xl mb-4 text-indigo-600">üë•</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Member Management</h3>
                        <p class="text-gray-600">Add and manage unlimited committee members with ease</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center hover:shadow-xl transition duration-300">
                        <div class="text-4xl mb-4 text-green-600">üí∞</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Payment Tracking</h3>
                        <p class="text-gray-600">Track monthly contributions and automatic penalty calculation</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center hover:shadow-xl transition duration-300">
                        <div class="text-4xl mb-4 text-red-600">üì§</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Expense Management</h3>
                        <p class="text-gray-600">Record expenses and automatically deduct from total balance</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center hover:shadow-xl transition duration-300">
                        <div class="text-4xl mb-4 text-purple-600">üìä</div>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Smart Reports</h3>
                        <p class="text-gray-600">Real-time financial reports and balance sheets</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Auth Modals -->
        <div id="authModals">
            <!-- Login Modal -->
            <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
                <div class="modal-content">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 text-indigo-600">üîê</div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Welcome Back</h3>
                        <p class="text-gray-600">Login to your account</p>
                    </div>
                    <div id="loginError" class="error-message hidden"></div>
                    <div id="loginSuccess" class="success-message hidden"></div>
                    <form onsubmit="handleLogin(event)" class="space-y-5">
                        <div>
                            <label class="block text-gray-700 mb-3 font-semibold">Email Address</label>
                            <input type="email" id="loginEmail" placeholder="Enter your email" 
                                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-300" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-3 font-semibold">Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" 
                                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-300" required>
                        </div>
                        <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                            Sign In to Dashboard
                        </button>
                        <div class="text-center mt-4">
                            <button type="button" onclick="showForgotPassword()" class="text-indigo-600 font-semibold hover:underline">
                                Forgot Password?
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-6">
                        <span class="text-gray-600">Don't have an account?</span>
                        <button onclick="switchToRegister()" class="text-indigo-600 font-semibold ml-2 hover:underline">
                            Create Account
                        </button>
                    </div>
                    <button onclick="hideAuthModals()" class="w-full mt-6 text-gray-500 hover:text-gray-700 text-center font-semibold">
                        ‚úï Close
                    </button>
                </div>
            </div>

            <!-- Forgot Password Modal -->
            <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
                <div class="modal-content">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 text-orange-600">üîë</div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Reset Password</h3>
                        <p class="text-gray-600">Enter your email to reset your password</p>
                    </div>
                    <div id="forgotPasswordError" class="error-message hidden"></div>
                    <div id="forgotPasswordSuccess" class="success-message hidden"></div>
                    <form onsubmit="handleForgotPassword(event)" class="space-y-5">
                        <div>
                            <label class="block text-gray-700 mb-3 font-semibold">Email Address</label>
                            <input type="email" id="forgotPasswordEmail" placeholder="Enter your registered email" 
                                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition duration-300" required>
                        </div>
                        <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                            Send Reset Link
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <span class="text-gray-600">Remember your password?</span>
                        <button onclick="switchToLogin()" class="text-indigo-600 font-semibold ml-2 hover:underline">
                            Back to Login
                        </button>
                    </div>
                    <button onclick="hideAuthModals()" class="w-full mt-6 text-gray-500 hover:text-gray-700 text-center font-semibold">
                        ‚úï Close
                    </button>
                </div>
            </div>

            <!-- Register Modal -->
            <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
                <div class="modal-content">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 text-green-600">üöÄ</div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Create Your Committee Account</h3>
                        <p class="text-gray-600">Start managing your committee finances</p>
                    </div>
                    <div id="registerError" class="error-message hidden"></div>
                    <div id="registerSuccess" class="success-message hidden"></div>
                    <form onsubmit="handleRegister(event)" class="space-y-5">
                        <!-- Account Type Selection -->
                        <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-800 mb-3 text-lg">Account Type</h4>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-3 flex-1 p-3 bg-white rounded-xl border-2 border-purple-300 cursor-pointer">
                                    <input type="radio" name="accountType" value="admin" checked class="text-purple-600 focus:ring-purple-500">
                                    <div>
                                        <span class="font-semibold text-gray-800">Admin User</span>
                                        <p class="text-sm text-gray-600">Create and manage committee</p>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 flex-1 p-3 bg-white rounded-xl border-2 border-gray-200 cursor-pointer">
                                    <input type="radio" name="accountType" value="member" class="text-purple-600 focus:ring-purple-500">
                                    <div>
                                        <span class="font-semibold text-gray-800">Member User</span>
                                        <p class="text-sm text-gray-600">Join existing committee</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Committee Information for Admin -->
                        <div id="adminCommitteeSection" class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 mb-4">
                            <h4 class="font-semibold text-blue-800 mb-3 text-lg">Committee Information</h4>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-semibold">Committee Name</label>
                                <input type="text" id="registerCommitteeName" placeholder="e.g., Unity of Madhupur" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300" required>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-semibold">Committee Code</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="registerCommitteeCode" placeholder="Create unique code" 
                                           class="flex-1 p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300" required>
                                    <button type="button" onclick="generateCommitteeCode()" class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition duration-300">
                                        Generate
                                    </button>
                                </div>
                                <p class="text-sm text-blue-600 mt-2">üí° Share this code with your committee members</p>
                            </div>
                        </div>

                        <!-- Committee Code for Members -->
                        <div id="memberCodeSection" class="bg-orange-50 p-4 rounded-xl border-2 border-orange-200 mb-4 hidden">
                            <h4 class="font-semibold text-orange-800 mb-3 text-lg">Join Existing Committee</h4>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Committee Code</label>
                                <input type="text" id="memberCommitteeCode" placeholder="Enter committee code from admin" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition duration-300">
                                <p class="text-sm text-orange-600 mt-2">üîë Ask your committee admin for this code</p>
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200 mb-4">
                            <h4 class="font-semibold text-green-800 mb-3 text-lg">Personal Information</h4>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-semibold">Your Full Name</label>
                                <input type="text" id="registerName" placeholder="Enter your full name" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-300" required>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-semibold">Email Address</label>
                                <input type="email" id="registerEmail" placeholder="Enter your email" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-300" required>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-semibold">Password</label>
                                <input type="password" id="registerPassword" placeholder="Minimum 6 characters" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-300" required minlength="6">
                            </div>
                        </div>

                        <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                            Create Committee Account
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <span class="text-gray-600">Already have an account?</span>
                        <button onclick="switchToLogin()" class="text-indigo-600 font-semibold ml-2 hover:underline">
                            Sign In
                        </button>
                    </div>
                    <button onclick="hideAuthModals()" class="w-full mt-6 text-gray-500 hover:text-gray-700 text-center font-semibold">
                        ‚úï Close
                    </button>
                </div>
            </div>

            <!-- Member View Modal -->
            <div id="memberViewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
                <div class="modal-content">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4 text-blue-600">üë•</div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Member View</h3>
                        <p class="text-gray-600">View committee information as a member</p>
                    </div>
                    <div id="memberViewError" class="error-message hidden"></div>
                    <form onsubmit="handleMemberView(event)" class="space-y-5">
                        <div>
                            <label class="block text-gray-700 mb-3 font-semibold">Your Name</label>
                            <input type="text" id="memberViewName" placeholder="Enter your name" 
                                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-3 font-semibold">Committee Code</label>
                            <input type="text" id="memberViewCode" placeholder="Enter committee code from admin" 
                                   class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300" required>
                        </div>
                        <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                            View Committee Info
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <span class="text-gray-600">Want full access?</span>
                        <button onclick="switchToRegister()" class="text-indigo-600 font-semibold ml-2 hover:underline">
                            Create Account
                        </button>
                    </div>
                    <button onclick="hideAuthModals()" class="w-full mt-6 text-gray-500 hover:text-gray-700 text-center font-semibold">
                        ‚úï Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Feature Modals -->
        <div id="featureModals"></div>

        <!-- Dashboard Sections -->
        <div id="dashboard" class="hidden min-h-screen bg-gray-50 py-8">
            <!-- Dynamic content will be loaded here -->
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl">
                <div class="flex items-center space-x-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <div>
                        <div class="text-lg font-semibold text-gray-800">Processing...</div>
                        <div class="text-gray-600 text-sm">Please wait a moment</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBwSaXtxyA-LjO0hkYN3hJqKzkJnxAu9lY",
            authDomain: "somiti-calculator.firebaseapp.com",
            projectId: "somiti-calculator",
            storageBucket: "somiti-calculator.firebasestorage.app",
            messagingSenderId: "365986998380",
            appId: "1:365986998380:web:1116d391768c7ab33ed049",
            measurementId: "G-17J083EQVZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentUserData = null;
        let currentSocietyId = null;
        let currentCommitteeName = null;

        // UI Management functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.innerHTML = `
                <div class="bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-xl">
                    <strong class="font-bold">‚ö†Ô∏è Error: </strong>
                    <span class="block sm:inline">${message}</span>
                </div>
            `;
            errorElement.classList.remove('hidden');
        }

        function showSuccessMessage(elementId, message) {
            const successElement = document.getElementById(elementId);
            successElement.innerHTML = `
                <div class="bg-green-50 border-2 border-green-200 text-green-700 px-4 py-3 rounded-xl">
                    <strong class="font-bold">‚úÖ Success: </strong>
                    <span class="block sm:inline">${message}</span>
                </div>
            `;
            successElement.classList.remove('hidden');
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.add('hidden');
        }

        function hideSuccess(elementId) {
            const successElement = document.getElementById(elementId);
            successElement.classList.add('hidden');
        }

        function showSuccess(message) {
            const modal = document.getElementById('featureModals');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="modal-content">
                        <div class="text-center">
                            <div class="text-4xl mb-4 text-green-600">‚úÖ</div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">Success!</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                            <button onclick="hideModals()" class="btn-primary px-6 py-3">Close</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function hideModals() {
            document.getElementById('featureModals').innerHTML = '';
        }

        function showLogin() {
            hideError('loginError');
            hideSuccess('loginSuccess');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('memberViewModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
        }

        function showRegister() {
            hideError('registerError');
            hideSuccess('registerSuccess');
            document.getElementById('registerName').value = '';
            document.getElementById('registerCommitteeName').value = '';
            document.getElementById('registerCommitteeCode').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('memberCommitteeCode').value = '';
            
            // Reset to admin by default
            document.querySelector('input[value="admin"]').checked = true;
            document.getElementById('adminCommitteeSection').classList.remove('hidden');
            document.getElementById('memberCodeSection').classList.add('hidden');
            
            document.getElementById('registerModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('memberViewModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
        }

        function showMemberView() {
            hideError('memberViewError');
            document.getElementById('memberViewName').value = '';
            document.getElementById('memberViewCode').value = '';
            document.getElementById('memberViewModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
        }

        // NEW: Show Forgot Password Modal
        function showForgotPassword() {
            hideError('forgotPasswordError');
            hideSuccess('forgotPasswordSuccess');
            document.getElementById('forgotPasswordEmail').value = '';
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('memberViewModal').classList.add('hidden');
        }

        function switchToRegister() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            showRegister();
        }

        function switchToLogin() {
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('memberViewModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            showLogin();
        }

        function hideAuthModals() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('memberViewModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.add('hidden');
        }

        // Generate random committee code
        function generateCommitteeCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('registerCommitteeCode').value = code;
        }

        // Toggle sections based on account type
        document.addEventListener('DOMContentLoaded', function() {
            const accountTypeRadios = document.querySelectorAll('input[name="accountType"]');
            const adminCommitteeSection = document.getElementById('adminCommitteeSection');
            const memberCodeSection = document.getElementById('memberCodeSection');
            
            accountTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'member') {
                        adminCommitteeSection.classList.add('hidden');
                        memberCodeSection.classList.remove('hidden');
                        document.getElementById('registerCommitteeCode').required = false;
                        document.getElementById('memberCommitteeCode').required = true;
                        document.getElementById('registerCommitteeName').required = false;
                    } else {
                        adminCommitteeSection.classList.remove('hidden');
                        memberCodeSection.classList.add('hidden');
                        document.getElementById('registerCommitteeCode').required = true;
                        document.getElementById('memberCommitteeCode').required = false;
                        document.getElementById('registerCommitteeName').required = true;
                    }
                });
            });

            // Test Firestore connection on load
            testFirestoreConnection();
        });

        // Test Firestore connection
        async function testFirestoreConnection() {
            try {
                console.log('Testing Firestore connection...');
                const testRef = db.collection('connection_test').doc('test');
                await testRef.set({
                    timestamp: new Date(),
                    test: true
                });
                console.log('‚úÖ Firestore connection: SUCCESS');
                await testRef.delete();
            } catch (error) {
                console.error('‚ùå Firestore connection failed:', error);
            }
        }

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth State Changed:', user);
            currentUser = user;
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        currentSocietyId = currentUserData.societyId;
                        currentCommitteeName = currentUserData.committeeName;
                        console.log('User data loaded:', currentUserData);
                        console.log('User role:', currentUserData.role);
                        showUserDashboard(user, currentUserData);
                    } else {
                        console.log('User document not found for:', user.uid);
                        showPublicHomepage();
                        showLogin();
                    }
                } catch (error) {
                    console.error('Error in auth state change:', error);
                    showPublicHomepage();
                }
            } else {
                showPublicHomepage();
            }
        });

        // Login function
        async function handleLogin(e) {
            e.preventDefault();
            showLoading();
            hideError('loginError');
            hideSuccess('loginSuccess');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                console.log('Attempting login for:', email);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('Login successful, user:', user.uid);
                
                // Get user data
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    throw new Error('User account not found. Please register first.');
                }
                
                currentUserData = userDoc.data();
                currentSocietyId = currentUserData.societyId;
                currentCommitteeName = currentUserData.committeeName;
                
                console.log('User role after login:', currentUserData.role);
                
                hideAuthModals();
                hideLoading();
                
            } catch (error) {
                hideLoading();
                console.error('Login error:', error);
                let errorMessage = '';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email. Please register first.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    default:
                        errorMessage = error.message || 'Login failed. Please check your credentials.';
                }
                
                showError('loginError', errorMessage);
            }
        }

        // NEW: Forgot Password function
        async function handleForgotPassword(e) {
            e.preventDefault();
            showLoading();
            hideError('forgotPasswordError');
            hideSuccess('forgotPasswordSuccess');
            
            const email = document.getElementById('forgotPasswordEmail').value.trim().toLowerCase();

            try {
                if (!email) {
                    throw new Error('Please enter your email address.');
                }

                console.log('Sending password reset email to:', email);
                
                // Send password reset email using Firebase
                await auth.sendPasswordResetEmail(email);
                
                hideLoading();
                
                // Show success message
                showSuccessMessage('forgotPasswordSuccess', 
                    'Password reset email sent successfully! Please check your email inbox and spam folder for the reset link.');
                
                // Clear email field
                document.getElementById('forgotPasswordEmail').value = '';
                
                // Auto hide modal after 5 seconds
                setTimeout(() => {
                    switchToLogin();
                }, 5000);
                
            } catch (error) {
                hideLoading();
                console.error('Password reset error:', error);
                let errorMessage = '';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email address.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many requests. Please try again later.';
                        break;
                    default:
                        errorMessage = error.message || 'Failed to send reset email. Please try again.';
                }
                
                showError('forgotPasswordError', errorMessage);
            }
        }

        // Register function
        async function handleRegister(e) {
            e.preventDefault();
            showLoading();
            hideError('registerError');
            hideSuccess('registerSuccess');
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const accountType = document.querySelector('input[name="accountType"]:checked').value;
            
            let committeeCode = '';
            let committeeName = '';

            try {
                console.log('üöÄ Starting registration process...');
                console.log('Account type selected:', accountType);

                // Basic validation
                if (!name || !email || !password) {
                    throw new Error('Please fill in all required fields.');
                }

                if (accountType === 'admin') {
                    committeeCode = document.getElementById('registerCommitteeCode').value.trim().toUpperCase();
                    committeeName = document.getElementById('registerCommitteeName').value.trim();
                    
                    if (!committeeCode) throw new Error('Please enter a committee code.');
                    if (!committeeName) throw new Error('Please enter a committee name.');
                    
                    // Check if committee code already exists
                    const committeeCheck = await db.collection('committees').doc(committeeCode).get();
                    if (committeeCheck.exists) {
                        throw new Error('Committee code already exists. Please choose a different code.');
                    }
                } else {
                    committeeCode = document.getElementById('memberCommitteeCode').value.trim().toUpperCase();
                    if (!committeeCode) throw new Error('Please enter committee code from admin.');
                    
                    // Verify committee exists for member
                    const committeeCheck = await db.collection('committees').doc(committeeCode).get();
                    if (!committeeCheck.exists) {
                        throw new Error('Committee not found. Please check the committee code.');
                    }
                    committeeName = committeeCheck.data().name;
                }

                console.log('üìù Creating Firebase Auth user...');
                
                // STEP 1: Create Firebase Auth User
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('‚úÖ Firebase Auth user created:', user.uid);

                // Update profile
                await user.updateProfile({ displayName: name });

                // Send email verification
                await user.sendEmailVerification();
                console.log('üìß Email verification sent');

                // STEP 2: Create Committee Document (for admin only)
                if (accountType === 'admin') {
                    console.log('üè¢ Creating committee document as admin...');
                    const committeeData = {
                        name: committeeName,
                        code: committeeCode,
                        createdBy: user.uid,
                        createdAt: new Date(),
                        totalMembers: 1,
                        status: 'active',
                        adminEmail: email,
                        adminName: name,
                        monthlyContribution: 1100, // Default monthly amount
                        initialFund: 1100, // Initial Fund
                        members: [{
                            userId: user.uid,
                            name: name,
                            email: email,
                            role: 'admin',
                            joinDate: new Date(),
                            totalPaid: 0,
                            advance: 0,
                            due: 0
                        }]
                    };
                    
                    await db.collection('committees').doc(committeeCode).set(committeeData);
                    console.log('‚úÖ Committee document created with admin role');
                }

                // STEP 3: Create User Document
                console.log('üë§ Creating user document with role:', accountType);
                const userData = {
                    name: name,
                    committeeName: committeeName,
                    email: email,
                    role: accountType, // This will be 'admin' or 'member'
                    joinDate: new Date(),
                    status: 'active',
                    societyId: committeeCode,
                    createdAt: new Date(),
                    userId: user.uid,
                    lastLogin: new Date(),
                    totalPaid: 0,
                    advance: 0,
                    due: 0,
                    emailVerified: false
                };
                
                console.log('User data to be saved:', userData);
                await db.collection('users').doc(user.uid).set(userData);
                console.log('‚úÖ User document created with role:', accountType);

                // STEP 4: Verify the data was saved correctly
                const verifyDoc = await db.collection('users').doc(user.uid).get();
                console.log('Verified user data:', verifyDoc.data());

                // Set global variables
                currentUserData = userData;
                currentSocietyId = committeeCode;
                currentCommitteeName = committeeName;

                hideAuthModals();
                hideLoading();
                
                // Show success with email verification notice
                if (accountType === 'admin') {
                    showSuccess(`üéâ Committee created successfully!<br><br>
                    <strong>Committee:</strong> ${committeeName}<br>
                    <strong>Your Code:</strong> <code class="bg-gray-100 p-2 rounded text-lg font-bold">${committeeCode}</code><br><br>
                    <span class="text-sm text-gray-600">Share this code with members so they can join your committee.</span><br><br>
                    üìß <strong>Important:</strong> We've sent a verification email to ${email}. Please check your inbox and verify your email address.`);
                } else {
                    showSuccess(`‚úÖ Account created successfully!<br><br>
                    Welcome to <strong>${committeeName}</strong> committee.<br>
                    You can now access your committee dashboard.<br><br>
                    üìß <strong>Important:</strong> We've sent a verification email to ${email}. Please check your inbox and verify your email address.`);
                }
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Registration failed:', error);
                
                let errorMessage = 'Registration failed: ' + (error.message || 'Unknown error');
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email already registered. Please login or use forgot password.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Database permission denied. Please check Firestore rules.';
                }
                
                showError('registerError', errorMessage);
            }
        }

        // Member View function
        async function handleMemberView(e) {
            e.preventDefault();
            showLoading();
            hideError('memberViewError');
            
            const name = document.getElementById('memberViewName').value.trim();
            const code = document.getElementById('memberViewCode').value.trim().toUpperCase();

            try {
                if (!name || !code) {
                    throw new Error('Please enter both your name and committee code.');
                }

                console.log('Checking committee:', code);
                // Check if committee exists
                const committeeDoc = await db.collection('committees').doc(code).get();
                if (!committeeDoc.exists) {
                    throw new Error('Committee not found. Please check the committee code.');
                }

                const committeeData = committeeDoc.data();
                console.log('Committee found:', committeeData.name);
                
                // Create guest member data
                const guestMemberData = {
                    name: name,
                    role: 'guest',
                    societyId: code,
                    committeeName: committeeData.name,
                    isGuest: true,
                    email: 'guest@example.com'
                };
                
                currentUserData = guestMemberData;
                currentSocietyId = code;
                currentCommitteeName = committeeData.name;
                
                hideAuthModals();
                hideLoading();
                showUserDashboard({ uid: 'guest_' + Date.now() }, guestMemberData);
                
            } catch (error) {
                hideLoading();
                console.error('Member view error:', error);
                showError('memberViewError', error.message || 'Error accessing committee information. Please check the code and try again.');
            }
        }

        // NEW: Admin Password Reset function (for admin to reset member passwords)
        async function resetMemberPassword(memberId) {
            try {
                const memberDoc = await db.collection('users').doc(memberId).get();
                const member = memberDoc.data();
                
                if (confirm(`Send password reset email to ${member.email}?`)) {
                    showLoading();
                    
                    // Send password reset email
                    await auth.sendPasswordResetEmail(member.email);
                    
                    hideLoading();
                    showSuccess(`Password reset email sent to ${member.email}. They can reset their password using the link.`);
                }
            } catch (error) {
                hideLoading();
                console.error('Error sending password reset:', error);
                showError('Error sending password reset: ' + error.message);
            }
        }

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                currentUserData = null;
                currentSocietyId = null;
                currentCommitteeName = null;
                console.log('User logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout Error: ' + error.message);
            }
        }

        function showUserDashboard(user, userData) {
            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userMenu').classList.remove('hidden');
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userRole').textContent = getRoleText(userData.role);
            
            console.log('Showing dashboard for role:', userData.role);
            loadUserDashboard(user.uid, userData);
        }

        function showPublicHomepage() {
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userMenu').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'Admin',
                'member': 'Member',
                'guest': 'Guest'
            };
            return roles[role] || role;
        }

        async function loadUserDashboard(uid, userData) {
            const dashboard = document.getElementById('dashboard');
            dashboard.classList.remove('hidden');
            
            console.log('Loading dashboard for role:', userData.role);
            
            if (userData.role === 'admin') {
                // Admin Dashboard
                dashboard.innerHTML = `
                    <div class="max-w-7xl mx-auto py-8 px-4">
                        <div class="text-center mb-12">
                            <h2 class="text-5xl font-bold text-gray-800 mb-4">${userData.committeeName || 'Admin'} Dashboard</h2>
                            <p class="text-xl text-gray-600">Complete financial control of your committee</p>
                            <div class="bg-indigo-100 border-2 border-indigo-300 p-4 rounded-xl mt-4 inline-block">
                                <p class="text-indigo-800 font-semibold">
                                    Committee Code: <code class="bg-white px-3 py-1 rounded-lg text-lg font-bold">${currentSocietyId}</code>
                                </p>
                                <p class="text-sm text-indigo-600 mt-1">Share this code with your committee members</p>
                            </div>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                            <div class="stat-card border-l-green-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Members</h3>
                                        <p class="text-3xl font-bold text-green-600" id="totalMembers">0</p>
                                    </div>
                                    <div class="text-3xl text-green-500">üë•</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-blue-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Collection</h3>
                                        <p class="text-3xl font-bold text-blue-600" id="totalCollection">0 Taka</p>
                                    </div>
                                    <div class="text-3xl text-blue-500">üí∞</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-red-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Expenses</h3>
                                        <p class="text-3xl font-bold text-red-600" id="totalExpenses">0 Taka</p>
                                    </div>
                                    <div class="text-3xl text-red-500">üì§</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-purple-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Net Balance</h3>
                                        <p class="text-3xl font-bold text-purple-600" id="netBalance">0 Taka</p>
                                    </div>
                                    <div class="text-3xl text-purple-500">‚öñÔ∏è</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                            <h3 class="text-3xl font-semibold mb-8 text-gray-800 text-center">Admin Quick Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6">
                                <button onclick="showMemberManagement()" class="action-btn border-green-200 hover:border-green-400">
                                    <div class="text-4xl mb-3 text-green-600">üë•</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Manage Members</h4>
                                    <p class="text-sm text-gray-600">Add/Edit members</p>
                                </button>
                                <button onclick="showPaymentManagement()" class="action-btn border-blue-200 hover:border-blue-400">
                                    <div class="text-4xl mb-3 text-blue-600">üí∞</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Payment Entry</h4>
                                    <p class="text-sm text-gray-600">Record payments</p>
                                </button>
                                <button onclick="showExpenseManagement()" class="action-btn border-red-200 hover:border-red-400">
                                    <div class="text-4xl mb-3 text-red-600">üì§</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Expense Entry</h4>
                                    <p class="text-sm text-gray-600">Add expenses</p>
                                </button>
                                <button onclick="showPenaltyManagement()" class="action-btn border-orange-200 hover:border-orange-400">
                                    <div class="text-4xl mb-3 text-orange-600">‚ö°</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Manage Penalty</h4>
                                    <p class="text-sm text-gray-600">Late fees</p>
                                </button>
                                <button onclick="showRecentTransactions()" class="action-btn border-purple-200 hover:border-purple-400">
                                    <div class="text-4xl mb-3 text-purple-600">üìã</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Recent Transactions</h4>
                                    <p class="text-sm text-gray-600">View & Edit Transactions</p>
                                </button>
                                <button onclick="showFinancialReports()" class="action-btn border-indigo-200 hover:border-indigo-400">
                                    <div class="text-4xl mb-3 text-indigo-600">üìä</div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Financial Reports</h4>
                                    <p class="text-sm text-gray-600">Complete overview</p>
                                </button>
                            </div>
                        </div>

                        <!-- Recent Transactions Preview -->
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-3xl font-semibold text-gray-800">Recent Transactions</h3>
                                <button onclick="showRecentTransactions()" class="btn-primary">View All Transactions</button>
                            </div>
                            <div id="recentTransactionsList" class="space-y-4">
                                <div class="text-center p-8 text-gray-500">
                                    Loading recent transactions...
                                </div>
                            </div>
                        </div>

                        <!-- Admin Panel -->
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <h3 class="text-3xl font-semibold mb-6 text-gray-800 text-center">Admin Panel</h3>
                            <div id="recentActivity" class="text-gray-600">
                                <div class="text-center p-8">
                                    <div class="text-6xl mb-4 text-indigo-600">üëë</div>
                                    <h4 class="text-2xl font-bold text-gray-800 mb-4">Welcome, Admin!</h4>
                                    <p class="text-xl text-gray-600 mb-6">You have full control over <strong>${currentCommitteeName}</strong> committee.</p>
                                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-2xl text-white">
                                        <h4 class="text-2xl font-bold mb-3">Your Committee Code</h4>
                                        <p class="text-4xl font-bold mb-4">${currentSocietyId}</p>
                                        <p class="text-indigo-100">Share this code with members so they can join your committee</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                loadAdminStats();
                loadRecentTransactions();
            } else {
                // Member or Guest Dashboard
                dashboard.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 px-4">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl font-bold text-gray-800 mb-4">${userData.committeeName || 'Committee'} - ${userData.role === 'guest' ? 'Guest' : 'Member'} Dashboard</h2>
                            <p class="text-xl text-gray-600">Your personal committee information</p>
                            ${userData.role === 'guest' ? `
                                <div class="bg-yellow-100 border-2 border-yellow-300 p-4 rounded-xl mt-4 inline-block">
                                    <p class="text-yellow-800 font-semibold">
                                        üëã Guest View - Limited access
                                    </p>
                                    <p class="text-sm text-yellow-600 mt-1">Create an account for full access</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Task Collection - Member can only see their own data -->
                        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8 border-l-4 border-green-500">
                            <h3 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Your Financial Status</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-green-600">üí∞</div>
                                    <p class="text-gray-600 mb-2">Your Total Paid</p>
                                    <p class="text-3xl font-bold text-green-600">${userData.totalPaid || 0} Taka</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-blue-600">üì§</div>
                                    <p class="text-gray-600 mb-2">Your Advance</p>
                                    <p class="text-3xl font-bold text-blue-600">${userData.advance || 0} Taka</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-red-600">‚ö°</div>
                                    <p class="text-gray-600 mb-2">Your Due</p>
                                    <p class="text-3xl font-bold text-red-600">${userData.due || 0} Taka</p>
                                </div>
                            </div>
                        </div>

                        <!-- Your Status -->
                        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8 border-l-4 border-indigo-500">
                            <h3 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Your Status</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-green-600">‚úÖ</div>
                                    <p class="text-gray-600 mb-2">Account Status</p>
                                    <p class="text-3xl font-bold text-green-600">Active</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-blue-600">üë§</div>
                                    <p class="text-gray-600 mb-2">Your Role</p>
                                    <p class="text-3xl font-bold text-blue-600">${userData.role}</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl mb-4 text-purple-600">üìÖ</div>
                                    <p class="text-gray-600 mb-2">Member Since</p>
                                    <p class="text-3xl font-bold text-purple-600">${new Date().getFullYear()}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Committee Information -->
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                            <h3 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Committee Information</h3>
                            <div id="memberRecentActivity" class="space-y-4">
                                <div class="flex items-center justify-center space-x-3 p-4 bg-green-50 rounded-xl border-2 border-green-200">
                                    <div class="text-2xl text-green-600">üëã</div>
                                    <div class="text-left">
                                        <p class="font-semibold text-green-800">Welcome to ${currentCommitteeName}!</p>
                                        <p class="text-sm text-green-600">You're now connected to the committee</p>
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                                    <p class="font-semibold text-blue-800">Committee Information</p>
                                    <p class="text-blue-600">Committee Code: <strong>${currentSocietyId}</strong></p>
                                    <p class="text-blue-600">Your Role: <strong>${userData.role}</strong></p>
                                </div>
                            </div>
                        </div>

                        <!-- Members List -->
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <h3 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Committee Members</h3>
                            <div id="committeeMembers" class="text-center text-gray-500">
                                <p>Loading committee members...</p>
                            </div>
                        </div>
                    </div>
                `;
                loadMemberData(uid);
            }
        }

        // Load admin statistics
        async function loadAdminStats() {
            try {
                if (!currentSocietyId) {
                    console.error('No society ID available');
                    return;
                }

                // Get total members
                const usersSnapshot = await db.collection('users')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                document.getElementById('totalMembers').textContent = usersSnapshot.size;

                // Get total collection (ONLY from contributions that are not advance)
                const contributionsSnapshot = await db.collection('contributions')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                
                let totalCollection = 0;
                contributionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    // Only count monthly contributions and due clearances, NOT advance payments
                    if (data.paymentType !== 'advance') {
                        totalCollection += data.amount || 0;
                    }
                });
                
                document.getElementById('totalCollection').textContent = totalCollection.toLocaleString() + ' Taka';

                // Get total expenses
                const expensesSnapshot = await db.collection('expenses')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                let totalExpenses = 0;
                expensesSnapshot.forEach(doc => {
                    totalExpenses += doc.data().amount || 0;
                });
                document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' Taka';

                // Calculate net balance
                const netBalance = totalCollection - totalExpenses;
                document.getElementById('netBalance').textContent = netBalance.toLocaleString() + ' Taka';

            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        // Load recent transactions
        async function loadRecentTransactions() {
            try {
                if (!currentSocietyId) {
                    console.error('No society ID available');
                    return;
                }

                // Get recent transactions (contributions and expenses)
                let contributionsSnapshot, expensesSnapshot;
                
                try {
                    // Try the indexed query first
                    contributionsSnapshot = await db.collection('contributions')
                        .where('societyId', '==', currentSocietyId)
                        .orderBy('recordedAt', 'desc')
                        .limit(5)
                        .get();
                } catch (indexError) {
                    console.warn('Index error for contributions, falling back to client-side sorting:', indexError);
                    // Fallback: get all and sort client-side
                    const allContributions = await db.collection('contributions')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                    
                    // Sort by recordedAt descending and take first 5
                    contributionsSnapshot = {
                        docs: allContributions.docs
                            .sort((a, b) => new Date(b.data().recordedAt?.toDate?.() || b.data().recordedAt) - 
                                          new Date(a.data().recordedAt?.toDate?.() || a.data().recordedAt))
                            .slice(0, 5)
                    };
                }

                try {
                    // Try the indexed query first
                    expensesSnapshot = await db.collection('expenses')
                        .where('societyId', '==', currentSocietyId)
                        .orderBy('recordedAt', 'desc')
                        .limit(5)
                        .get();
                } catch (indexError) {
                    console.warn('Index error for expenses, falling back to client-side sorting:', indexError);
                    // Fallback: get all and sort client-side
                    const allExpenses = await db.collection('expenses')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                    
                    // Sort by recordedAt descending and take first 5
                    expensesSnapshot = {
                        docs: allExpenses.docs
                            .sort((a, b) => new Date(b.data().recordedAt?.toDate?.() || b.data().recordedAt) - 
                                          new Date(a.data().recordedAt?.toDate?.() || a.data().recordedAt))
                            .slice(0, 5)
                    };
                }

                // Combine and sort transactions
                const transactions = [];
                
                contributionsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        type: 'payment',
                        ...data,
                        transactionDate: data.paymentDate || data.recordedAt
                    });
                });
                
                expensesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        type: 'expense',
                        ...data,
                        transactionDate: data.expenseDate || data.recordedAt
                    });
                });

                // Sort by date (newest first) - additional client-side sort
                transactions.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));
                
                // Display transactions
                const transactionsList = document.getElementById('recentTransactionsList');
                
                if (transactions.length === 0) {
                    transactionsList.innerHTML = `
                        <div class="text-center p-8 text-gray-500">
                            No transactions found. Record your first payment or expense to see them here.
                        </div>
                    `;
                    return;
                }

                let transactionsHTML = '';
                transactions.forEach(transaction => {
                    const date = new Date(transaction.transactionDate).toLocaleDateString();
                    const amount = transaction.amount || 0;
                    
                    if (transaction.type === 'payment') {
                        transactionsHTML += `
                            <div class="transaction-item payment-transaction">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">${transaction.memberName || 'Member'}</h4>
                                        <p class="text-sm text-gray-600">${transaction.paymentType || 'Payment'} - ${transaction.description || 'No description'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${date} ‚Ä¢ ${transaction.month || ''}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-green-600 font-bold">+${amount} Tk</p>
                                        <button onclick="editTransaction('${transaction.id}', 'payment')" class="text-blue-600 text-sm mt-1 hover:underline">Edit</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (transaction.type === 'expense') {
                        transactionsHTML += `
                            <div class="transaction-item expense-transaction">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">${transaction.category || 'Expense'}</h4>
                                        <p class="text-sm text-gray-600">${transaction.description || 'No description'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-red-600 font-bold">-${amount} Tk</p>
                                        <button onclick="editTransaction('${transaction.id}', 'expense')" class="text-blue-600 text-sm mt-1 hover:underline">Edit</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                transactionsList.innerHTML = transactionsHTML;

            } catch (error) {
                console.error('Error loading recent transactions:', error);
                let errorMessage = 'Error loading transactions';
                
                if (error.message.includes('index')) {
                    errorMessage += `. The system needs to create an index. This should happen automatically, but if the problem persists, please contact support.`;
                } else {
                    errorMessage += `: ${error.message}`;
                }
                
                document.getElementById('recentTransactionsList').innerHTML = `
                    <div class="error-message">
                        ${errorMessage}
                    </div>
                `;
            }
        }

        // Load member data
        async function loadMemberData(uid) {
            try {
                if (!currentSocietyId) return;

                // Load committee members for display
                const membersSnapshot = await db.collection('users')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                
                let membersHTML = '';
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    membersHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                            <span class="font-medium">${member.name}</span>
                            <span class="text-sm text-gray-600">${member.role}</span>
                        </div>
                    `;
                });

                document.getElementById('committeeMembers').innerHTML = membersHTML || '<p class="text-gray-500">No members found</p>';

            } catch (error) {
                console.error('Error loading member data:', error);
                document.getElementById('committeeMembers').innerHTML = '<p class="text-red-500">Error loading members</p>';
            }
        }

        // ============================
        // FINANCIAL REPORTS FEATURE - UPDATED
        // ============================

        // Show Financial Reports
        async function showFinancialReports() {
            try {
                showLoading();
                
                // Get all financial data
                const [membersSnapshot, contributionsSnapshot, expensesSnapshot, penaltiesSnapshot, dueClearancesSnapshot] = await Promise.all([
                    db.collection('users').where('societyId', '==', currentSocietyId).get(),
                    db.collection('contributions').where('societyId', '==', currentSocietyId).get(),
                    db.collection('expenses').where('societyId', '==', currentSocietyId).get(),
                    db.collection('penalties').where('societyId', '==', currentSocietyId).get(),
                    db.collection('contributions').where('societyId', '==', currentSocietyId).where('paymentType', '==', 'due_clearance').get()
                ]);

                // Calculate financial totals - FIXED: Advance payments NOT included in total collection
                let totalCollection = 0;
                let totalAdvancePayments = 0;
                let totalMonthlyContributions = 0;
                let totalDueClearances = 0;
                
                contributionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.paymentType === 'monthly') {
                        totalMonthlyContributions += data.amount || 0;
                        totalCollection += data.amount || 0;
                    } else if (data.paymentType === 'advance') {
                        totalAdvancePayments += data.amount || 0;
                        // Advance payments are NOT added to total collection
                    } else if (data.paymentType === 'due_clearance') {
                        totalDueClearances += data.amount || 0;
                        totalCollection += data.amount || 0;
                    } else if (data.paymentType === 'initial_fund') {
                        totalCollection += data.amount || 0;
                    }
                });

                let totalExpenses = 0;
                expensesSnapshot.forEach(doc => {
                    totalExpenses += doc.data().amount || 0;
                });

                let totalPenalties = 0;
                penaltiesSnapshot.forEach(doc => {
                    totalPenalties += doc.data().amount || 0;
                });

                const netBalance = totalCollection - totalExpenses;

                // Prepare member-wise summary - FIXED: Balance calculation
                let memberSummaryHTML = '';
                let totalMemberBalance = 0;
                let totalMemberPaid = 0;
                let totalMemberAdvance = 0;
                let totalMemberDue = 0;
                
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    // Member balance = (Total Paid) + (Advance) - (Due)
                    const memberBalance = (member.totalPaid || 0) + (member.advance || 0) - (member.due || 0);
                    totalMemberBalance += memberBalance;
                    totalMemberPaid += member.totalPaid || 0;
                    totalMemberAdvance += member.advance || 0;
                    totalMemberDue += member.due || 0;
                    
                    memberSummaryHTML += `
                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                            <td class="p-4 text-left font-medium text-gray-800">${member.name}</td>
                            <td class="p-4 text-right text-green-600 font-semibold">${(member.totalPaid || 0).toLocaleString()} Tk</td>
                            <td class="p-4 text-right text-blue-600 font-semibold">${(member.advance || 0).toLocaleString()} Tk</td>
                            <td class="p-4 text-right text-red-600 font-semibold">${(member.due || 0).toLocaleString()} Tk</td>
                            <td class="p-4 text-right font-bold ${memberBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${memberBalance.toLocaleString()} Tk
                            </td>
                        </tr>
                    `;
                });

                // Prepare Due Clearance History Section
                let dueClearanceHTML = '';
                if (dueClearancesSnapshot.size > 0) {
                    dueClearanceHTML = `
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">Due Clearance History</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50 border-b-2 border-gray-200">
                                            <th class="p-4 text-left font-semibold text-gray-700">Date</th>
                                            <th class="p-4 text-left font-semibold text-gray-700">Member Name</th>
                                            <th class="p-4 text-right font-semibold text-gray-700">Cleared Amount</th>
                                            <th class="p-4 text-left font-semibold text-gray-700">Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Sort due clearances by date (newest first)
                    const dueClearancesList = [];
                    dueClearancesSnapshot.forEach(doc => {
                        const data = doc.data();
                        dueClearancesList.push({
                            date: data.paymentDate || data.recordedAt,
                            memberName: data.memberName,
                            amount: data.amount,
                            description: data.description
                        });
                    });
                    
                    // Sort by date descending
                    dueClearancesList.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    dueClearancesList.forEach(clearance => {
                        const date = new Date(clearance.date).toLocaleDateString();
                        dueClearanceHTML += `
                            <tr class="border-t border-gray-200 hover:bg-gray-50">
                                <td class="p-4 text-left text-gray-600">${date}</td>
                                <td class="p-4 text-left font-medium text-gray-800">${clearance.memberName}</td>
                                <td class="p-4 text-right text-green-600 font-semibold">${(clearance.amount || 0).toLocaleString()} Tk</td>
                                <td class="p-4 text-left text-gray-600">${clearance.description || 'Due Clearance'}</td>
                            </tr>
                        `;
                    });
                    
                    dueClearanceHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // Get recent transactions for the report
                const recentTransactions = [];
                contributionsSnapshot.docs.slice(0, 10).forEach(doc => {
                    const data = doc.data();
                    recentTransactions.push({
                        type: 'payment',
                        name: data.memberName,
                        amount: data.amount,
                        date: data.paymentDate || data.recordedAt,
                        description: data.description,
                        month: data.month,
                        paymentType: data.paymentType
                    });
                });

                expensesSnapshot.docs.slice(0, 10).forEach(doc => {
                    const data = doc.data();
                    recentTransactions.push({
                        type: 'expense',
                        name: data.category,
                        amount: data.amount,
                        date: data.expenseDate || data.recordedAt,
                        description: data.description
                    });
                });

                // Sort by date
                recentTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                let recentTransactionsHTML = '';
                recentTransactions.forEach(transaction => {
                    const date = new Date(transaction.date).toLocaleDateString();
                    const isPayment = transaction.type === 'payment';
                    
                    let paymentTypeBadge = '';
                    if (isPayment && transaction.paymentType === 'advance') {
                        paymentTypeBadge = '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded ml-2">Advance</span>';
                    } else if (isPayment && transaction.paymentType === 'due_clearance') {
                        paymentTypeBadge = '<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded ml-2">Due Clearance</span>';
                    }
                    
                    recentTransactionsHTML += `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full ${isPayment ? 'bg-green-500' : 'bg-red-500'}"></div>
                                <div>
                                    <div class="flex items-center">
                                        <p class="font-medium text-gray-800">${transaction.name}</p>
                                        ${paymentTypeBadge}
                                    </div>
                                    <p class="text-sm text-gray-600">${transaction.description || 'No description'}</p>
                                    <p class="text-xs text-gray-500">${date}${transaction.month ? ` ‚Ä¢ ${transaction.month}` : ''}</p>
                                </div>
                            </div>
                            <span class="font-bold ${isPayment ? 'text-green-600' : 'text-red-600'}">
                                ${isPayment ? '+' : '-'}${transaction.amount} Tk
                            </span>
                        </div>
                    `;
                });

                // Generate report HTML
                const reportHTML = `
                    <div class="space-y-8">
                        <!-- Header -->
                        <div class="text-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl">
                            <h1 class="text-4xl font-bold mb-4">Financial Report</h1>
                            <p class="text-xl opacity-90">${currentCommitteeName}</p>
                            <p class="text-lg opacity-80">Generated on ${new Date().toLocaleDateString()}</p>
                        </div>

                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="stat-card border-l-green-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Collection</h3>
                                        <p class="text-3xl font-bold text-green-600">${totalCollection.toLocaleString()} Tk</p>
                                    </div>
                                    <div class="text-3xl text-green-500">üí∞</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-red-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Expenses</h3>
                                        <p class="text-3xl font-bold text-red-600">${totalExpenses.toLocaleString()} Tk</p>
                                    </div>
                                    <div class="text-3xl text-red-500">üì§</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-purple-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Net Balance</h3>
                                        <p class="text-3xl font-bold text-purple-600">${netBalance.toLocaleString()} Tk</p>
                                    </div>
                                    <div class="text-3xl text-purple-500">‚öñÔ∏è</div>
                                </div>
                            </div>
                            <div class="stat-card border-l-orange-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Penalties</h3>
                                        <p class="text-3xl font-bold text-orange-600">${totalPenalties.toLocaleString()} Tk</p>
                                    </div>
                                    <div class="text-3xl text-orange-500">‚ö°</div>
                                </div>
                            </div>
                        </div>

                        <!-- Member-wise Summary -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">Member-wise Summary</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50 border-b-2 border-gray-200">
                                            <th class="p-4 text-left font-semibold text-gray-700">Member</th>
                                            <th class="p-4 text-right font-semibold text-gray-700">Total Paid</th>
                                            <th class="p-4 text-right font-semibold text-gray-700">Advance</th>
                                            <th class="p-4 text-right font-semibold text-gray-700">Due</th>
                                            <th class="p-4 text-right font-semibold text-gray-700">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${memberSummaryHTML}
                                        <tr class="bg-gray-50 border-t-2 border-gray-200">
                                            <td class="p-4 text-left font-bold text-gray-800">Total</td>
                                            <td class="p-4 text-right font-bold text-green-600">
                                                ${totalMemberPaid.toLocaleString()} Tk
                                            </td>
                                            <td class="p-4 text-right font-bold text-blue-600">
                                                ${totalMemberAdvance.toLocaleString()} Tk
                                            </td>
                                            <td class="p-4 text-right font-bold text-red-600">
                                                ${totalMemberDue.toLocaleString()} Tk
                                            </td>
                                            <td class="p-4 text-right font-bold text-purple-600">
                                                ${totalMemberBalance.toLocaleString()} Tk
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Due Clearance History Section -->
                        ${dueClearanceHTML}

                        <!-- Recent Transactions -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">Recent Transactions</h3>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                ${recentTransactionsHTML || `
                                    <div class="text-center py-8 text-gray-500">
                                        No transactions found
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Income Breakdown</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Monthly Contributions</span>
                                        <span class="font-semibold text-green-600">
                                            ${totalMonthlyContributions.toLocaleString()} Tk
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Advance Payments</span>
                                        <span class="font-semibold text-blue-600">
                                            ${totalAdvancePayments.toLocaleString()} Tk
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Due Clearances</span>
                                        <span class="font-semibold text-orange-600">
                                            ${totalDueClearances.toLocaleString()} Tk
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center border-t border-gray-200 pt-3">
                                        <span class="text-gray-800 font-bold">Total Collection</span>
                                        <span class="font-bold text-green-700">
                                            ${totalCollection.toLocaleString()} Tk
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Expense Breakdown</h3>
                                <div class="space-y-3">
                                    ${Object.entries(
                                        expensesSnapshot.docs.reduce((acc, doc) => {
                                            const category = doc.data().category || 'other';
                                            acc[category] = (acc[category] || 0) + (doc.data().amount || 0);
                                            return acc;
                                        }, {})
                                    ).map(([category, amount]) => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600 capitalize">${category.replace('_', ' ')}</span>
                                            <span class="font-semibold text-red-600">${amount.toLocaleString()} Tk</span>
                                        </div>
                                    `).join('')}
                                    <div class="flex justify-between items-center border-t border-gray-200 pt-3">
                                        <span class="text-gray-800 font-bold">Total Expenses</span>
                                        <span class="font-bold text-red-700">
                                            ${totalExpenses.toLocaleString()} Tk
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Print and Export Options -->
                        <div class="bg-gray-50 rounded-2xl p-6 border-2 border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Export Options</h3>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="printFinancialReport()" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition duration-300">
                                    üñ®Ô∏è Print Report
                                </button>
                                <button onclick="exportFinancialReportToPDF()" class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition duration-300">
                                    üìÑ Export as PDF
                                </button>
                                <button onclick="exportFinancialReportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition duration-300">
                                    üìä Export as Excel
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                hideLoading();

                // Display the report in modal
                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-purple-600">üìä</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Financial Reports</h3>
                                <p class="text-gray-600">Complete financial overview of your committee</p>
                            </div>
                            
                            ${reportHTML}

                            <button onclick="hideModals()" class="w-full mt-6 bg-gray-600 text-white p-4 rounded-xl hover:bg-gray-700 text-lg font-semibold">
                                Close Reports
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                hideLoading();
                console.error('Error generating financial report:', error);
                showError('Error generating financial report: ' + error.message);
            }
        }

        // ============================
        // EXPORT FUNCTIONS - UPDATED
        // ============================

        // Print Financial Report
        function printFinancialReport() {
            const modalContent = document.querySelector('.modal-content');
            const printWindow = window.open('', '_blank');
            
            // Remove export buttons from print version
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = modalContent.innerHTML;
            const exportSection = tempDiv.querySelector('.bg-gray-50');
            if (exportSection) {
                exportSection.remove();
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Financial Report - ${currentCommitteeName}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            color: #333;
                        }
                        .header { 
                            background: linear-gradient(135deg, #4F46E5, #7C3AED); 
                            color: white; 
                            padding: 30px; 
                            text-align: center; 
                            border-radius: 10px;
                            margin-bottom: 30px;
                        }
                        .summary-cards { 
                            display: grid; 
                            grid-template-columns: repeat(4, 1fr); 
                            gap: 15px; 
                            margin-bottom: 30px;
                        }
                        .card { 
                            padding: 20px; 
                            border-radius: 10px; 
                            border-left: 5px solid;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                        }
                        th, td { 
                            padding: 12px; 
                            text-align: left; 
                            border-bottom: 1px solid #ddd;
                        }
                        th { 
                            background-color: #f8fafc; 
                            font-weight: bold;
                        }
                        .positive { color: #10B981; }
                        .negative { color: #EF4444; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            @page { size: landscape; }
                        }
                    </style>
                </head>
                <body>
                    ${tempDiv.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Export Financial Report to PDF - UPDATED
        async function exportFinancialReportToPDF() {
            try {
                showLoading();
                
                // Get modal content
                const modalContent = document.querySelector('.modal-content');
                const contentToPrint = modalContent.cloneNode(true);
                
                // Remove export buttons
                const exportSection = contentToPrint.querySelector('.bg-gray-50');
                if (exportSection) {
                    exportSection.remove();
                }
                
                // Create a temporary div for rendering
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    width: 800px;
                    padding: 20px;
                    background: white;
                `;
                tempDiv.appendChild(contentToPrint);
                document.body.appendChild(tempDiv);
                
                // Use html2canvas
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                // Remove temp div
                document.body.removeChild(tempDiv);
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                const imgWidth = 280;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                const fileName = `Financial_Report_${currentCommitteeName}_${new Date().toISOString().slice(0, 10)}.pdf`;
                pdf.save(fileName);
                
                hideLoading();
                showSuccess('PDF exported successfully!');
                
            } catch (error) {
                hideLoading();
                console.error('Error exporting PDF:', error);
                
                // Simple fallback
                try {
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    
                    pdf.setFontSize(20);
                    pdf.text(`Financial Report - ${currentCommitteeName}`, 105, 20, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.text(`Committee Code: ${currentSocietyId}`, 105, 30, { align: 'center' });
                    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 35, { align: 'center' });
                    
                    const fileName = `Financial_Report_${currentCommitteeName}_${new Date().toISOString().slice(0, 10)}.pdf`;
                    pdf.save(fileName);
                    
                    showSuccess('Basic PDF exported. For better quality, use Print option.');
                } catch (fallbackError) {
                    showError('Error exporting PDF. Please use Print option instead.');
                }
            }
        }

        // Export Financial Report to Excel - UPDATED with Member-wise Summary
        async function exportFinancialReportToExcel() {
            try {
                showLoading();
                
                // Get all necessary data
                const [membersSnapshot, contributionsSnapshot, expensesSnapshot, dueClearancesSnapshot] = await Promise.all([
                    db.collection('users').where('societyId', '==', currentSocietyId).get(),
                    db.collection('contributions').where('societyId', '==', currentSocietyId).get(),
                    db.collection('expenses').where('societyId', '==', currentSocietyId).get(),
                    db.collection('contributions').where('societyId', '==', currentSocietyId).where('paymentType', '==', 'due_clearance').get()
                ]);
                
                // Calculate totals
                let totalCollection = 0;
                let totalAdvancePayments = 0;
                let totalMonthlyContributions = 0;
                let totalDueClearances = 0;
                
                contributionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.paymentType === 'monthly') {
                        totalMonthlyContributions += data.amount || 0;
                        totalCollection += data.amount || 0;
                    } else if (data.paymentType === 'advance') {
                        totalAdvancePayments += data.amount || 0;
                    } else if (data.paymentType === 'due_clearance') {
                        totalDueClearances += data.amount || 0;
                        totalCollection += data.amount || 0;
                    } else if (data.paymentType === 'initial_fund') {
                        totalCollection += data.amount || 0;
                    }
                });

                let totalExpenses = 0;
                expensesSnapshot.forEach(doc => {
                    totalExpenses += doc.data().amount || 0;
                });

                const netBalance = totalCollection - totalExpenses;

                // Prepare summary sheet data
                const summaryData = [
                    ['Financial Report', currentCommitteeName],
                    ['Committee Code', currentSocietyId],
                    ['Report Date', new Date().toLocaleDateString()],
                    ['Generated By', currentUserData?.name || 'Admin'],
                    [''],
                    ['Financial Summary'],
                    ['Total Members', membersSnapshot.size],
                    ['Total Collection', totalCollection],
                    ['Total Expenses', totalExpenses],
                    ['Net Balance', netBalance],
                    [''],
                    ['Income Breakdown'],
                    ['Monthly Contributions', totalMonthlyContributions],
                    ['Advance Payments', totalAdvancePayments],
                    ['Due Clearances', totalDueClearances],
                    [''],
                    ['Expense Breakdown']
                ];
                
                // Add expense categories
                const expenseCategories = expensesSnapshot.docs.reduce((acc, doc) => {
                    const category = doc.data().category || 'other';
                    acc[category] = (acc[category] || 0) + (doc.data().amount || 0);
                    return acc;
                }, {});
                
                Object.entries(expenseCategories).forEach(([category, amount]) => {
                    summaryData.push([category.charAt(0).toUpperCase() + category.slice(1), amount]);
                });
                
                // Prepare Member-wise Summary Sheet Data
                const memberSummaryData = [
                    ['Member Name', 'Email', 'Role', 'Total Paid', 'Advance', 'Due', 'Balance', 'Join Date', 'Status']
                ];
                
                let totalMemberBalance = 0;
                let totalMemberPaid = 0;
                let totalMemberAdvance = 0;
                let totalMemberDue = 0;
                
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    const balance = (member.totalPaid || 0) + (member.advance || 0) - (member.due || 0);
                    const joinDate = member.joinDate?.toDate ? member.joinDate.toDate().toLocaleDateString() : 'N/A';
                    
                    totalMemberBalance += balance;
                    totalMemberPaid += member.totalPaid || 0;
                    totalMemberAdvance += member.advance || 0;
                    totalMemberDue += member.due || 0;
                    
                    memberSummaryData.push([
                        member.name,
                        member.email,
                        member.role,
                        member.totalPaid || 0,
                        member.advance || 0,
                        member.due || 0,
                        balance,
                        joinDate,
                        member.status || 'active'
                    ]);
                });
                
                // Add totals row to member summary
                memberSummaryData.push(['']);
                memberSummaryData.push(['TOTAL', '', '', totalMemberPaid, totalMemberAdvance, totalMemberDue, totalMemberBalance, '', '']);
                
                // Prepare Due Clearance History Sheet
                const dueClearanceData = [
                    ['Date', 'Member Name', 'Cleared Amount', 'Description']
                ];
                
                const dueClearancesList = [];
                dueClearancesSnapshot.forEach(doc => {
                    const data = doc.data();
                    dueClearancesList.push({
                        date: data.paymentDate || data.recordedAt,
                        memberName: data.memberName,
                        amount: data.amount,
                        description: data.description
                    });
                });
                
                // Sort by date descending
                dueClearancesList.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                dueClearancesList.forEach(clearance => {
                    const date = new Date(clearance.date).toLocaleDateString();
                    dueClearanceData.push([
                        date,
                        clearance.memberName,
                        clearance.amount || 0,
                        clearance.description || 'Due Clearance'
                    ]);
                });
                
                // Prepare contributions sheet data
                const contributionsData = [
                    ['Date', 'Member Name', 'Payment Type', 'Amount', 'Month', 'Description', 'Recorded By']
                ];
                
                contributionsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.paymentDate || data.recordedAt?.toDate?.().toLocaleDateString() || 'N/A';
                    
                    contributionsData.push([
                        date,
                        data.memberName || 'N/A',
                        data.paymentType || 'N/A',
                        data.amount || 0,
                        data.month || 'N/A',
                        data.description || 'N/A',
                        data.recordedBy || 'N/A'
                    ]);
                });
                
                // Prepare expenses sheet data
                const expensesData = [
                    ['Date', 'Category', 'Amount', 'Description', 'Receipt', 'Recorded By']
                ];
                
                expensesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.expenseDate || data.recordedAt?.toDate?.().toLocaleDateString() || 'N/A';
                    
                    expensesData.push([
                        date,
                        data.category || 'N/A',
                        data.amount || 0,
                        data.description || 'N/A',
                        data.receipt || 'N/A',
                        data.recordedBy || 'N/A'
                    ]);
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Create worksheets
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                const memberSummaryWs = XLSX.utils.aoa_to_sheet(memberSummaryData);
                const dueClearanceWs = XLSX.utils.aoa_to_sheet(dueClearanceData);
                const contributionsWs = XLSX.utils.aoa_to_sheet(contributionsData);
                const expensesWs = XLSX.utils.aoa_to_sheet(expensesData);
                
                // Add worksheets to workbook
                XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
                XLSX.utils.book_append_sheet(wb, memberSummaryWs, "Member Summary");
                XLSX.utils.book_append_sheet(wb, dueClearanceWs, "Due Clearance History");
                XLSX.utils.book_append_sheet(wb, contributionsWs, "Contributions");
                XLSX.utils.book_append_sheet(wb, expensesWs, "Expenses");
                
                // Generate Excel file
                const fileName = `Financial_Report_${currentCommitteeName}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showSuccess('Excel file exported successfully with Member-wise Summary!');
                
            } catch (error) {
                hideLoading();
                console.error('Error exporting to Excel:', error);
                showError('Error exporting to Excel: ' + error.message);
            }
        }

        // ============================
        // OTHER WORKING FEATURE FUNCTIONS
        // ============================

        // Show all recent transactions
        async function showRecentTransactions() {
            try {
                // Get all transactions (contributions and expenses)
                let contributionsSnapshot, expensesSnapshot;
                
                try {
                    contributionsSnapshot = await db.collection('contributions')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                } catch (indexError) {
                    const allContributions = await db.collection('contributions')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                    
                    contributionsSnapshot = {
                        docs: allContributions.docs
                            .sort((a, b) => new Date(b.data().recordedAt?.toDate?.() || b.data().recordedAt) - 
                                          new Date(a.data().recordedAt?.toDate?.() || a.data().recordedAt))
                    };
                }

                try {
                    expensesSnapshot = await db.collection('expenses')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                } catch (indexError) {
                    const allExpenses = await db.collection('expenses')
                        .where('societyId', '==', currentSocietyId)
                        .get();
                    
                    expensesSnapshot = {
                        docs: allExpenses.docs
                            .sort((a, b) => new Date(b.data().recordedAt?.toDate?.() || b.data().recordedAt) - 
                                          new Date(a.data().recordedAt?.toDate?.() || a.data().recordedAt))
                    };
                }

                // Combine and sort transactions
                const transactions = [];
                
                contributionsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        type: 'payment',
                        collection: 'contributions',
                        ...data,
                        transactionDate: data.paymentDate || data.recordedAt
                    });
                });
                
                expensesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        type: 'expense',
                        collection: 'expenses',
                        ...data,
                        transactionDate: data.expenseDate || data.recordedAt
                    });
                });

                // Sort by date (newest first)
                transactions.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));
                
                // Display transactions in modal
                let transactionsHTML = '';
                
                if (transactions.length === 0) {
                    transactionsHTML = `
                        <div class="text-center p-8 text-gray-500">
                            No transactions found. Record your first payment or expense to see them here.
                        </div>
                    `;
                } else {
                    transactions.forEach(transaction => {
                        const date = new Date(transaction.transactionDate).toLocaleDateString();
                        const amount = transaction.amount || 0;
                        const typeClass = transaction.type === 'payment' ? 'payment-transaction' : 'expense-transaction';
                        const amountClass = transaction.type === 'payment' ? 'text-green-600' : 'text-red-600';
                        const amountSign = transaction.type === 'payment' ? '+' : '-';
                        
                        if (transaction.type === 'payment') {
                            const isAdvance = transaction.paymentType === 'advance';
                            const paymentTypeText = isAdvance ? 'Advance Payment' : (transaction.paymentType || 'Payment');
                            
                            transactionsHTML += `
                                <div class="transaction-item ${typeClass}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800">${transaction.memberName || 'Member'}</h4>
                                            <p class="text-sm text-gray-600">${paymentTypeText} - ${transaction.description || 'No description'}</p>
                                            <p class="text-xs text-gray-500 mt-1">${date} ‚Ä¢ ${transaction.month || ''}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="${amountClass} font-bold">${amountSign}${amount} Tk</p>
                                            <div class="flex space-x-2 mt-1">
                                                <button onclick="editTransaction('${transaction.id}', 'payment')" class="text-blue-600 text-sm hover:underline">Edit</button>
                                                <button onclick="deleteTransaction('${transaction.id}', '${transaction.collection}')" class="text-red-600 text-sm hover:underline">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (transaction.type === 'expense') {
                            transactionsHTML += `
                                <div class="transaction-item ${typeClass}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800">${transaction.category || 'Expense'}</h4>
                                            <p class="text-sm text-gray-600">${transaction.description || 'No description'}</p>
                                            <p class="text-xs text-gray-500 mt-1">${date}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="${amountClass} font-bold">${amountSign}${amount} Tk</p>
                                            <div class="flex space-x-2 mt-1">
                                                <button onclick="editTransaction('${transaction.id}', 'expense')" class="text-blue-600 text-sm hover:underline">Edit</button>
                                                <button onclick="deleteTransaction('${transaction.id}', '${transaction.collection}')" class="text-red-600 text-sm hover:underline">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }

                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-purple-600">üìã</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Recent Transactions</h3>
                                <p class="text-gray-600">View and manage all committee transactions</p>
                            </div>
                            
                            <div class="bg-white rounded-xl border-2 border-gray-200 p-4 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-gray-800 text-lg">All Transactions (${transactions.length})</h4>
                                    <div class="flex space-x-2">
                                        <button onclick="showPaymentManagement()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700">Add Payment</button>
                                        <button onclick="showExpenseManagement()" class="bg-red-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-700">Add Expense</button>
                                    </div>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    ${transactionsHTML}
                                </div>
                            </div>

                            <button onclick="hideModals()" class="w-full bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading transactions:', error);
                let errorMessage = 'Error loading transactions';
                showError(errorMessage);
            }
        }

        // Edit transaction - FIXED to update member financial records
        async function editTransaction(transactionId, transactionType) {
            try {
                let transactionData = null;
                let collectionName = '';
                
                if (transactionType === 'payment') {
                    collectionName = 'contributions';
                    const doc = await db.collection(collectionName).doc(transactionId).get();
                    transactionData = doc.data();
                } else if (transactionType === 'expense') {
                    collectionName = 'expenses';
                    const doc = await db.collection(collectionName).doc(transactionId).get();
                    transactionData = doc.data();
                }
                
                if (!transactionData) {
                    throw new Error('Transaction not found');
                }
                
                // Create edit form based on transaction type
                let formHTML = '';
                
                if (transactionType === 'payment') {
                    formHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Member Name</label>
                                <input type="text" id="editMemberName" value="${transactionData.memberName || ''}" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" readonly>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Payment Type</label>
                                    <select id="editPaymentType" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                        <option value="monthly" ${transactionData.paymentType === 'monthly' ? 'selected' : ''}>Monthly Contribution</option>
                                        <option value="advance" ${transactionData.paymentType === 'advance' ? 'selected' : ''}>Advance Payment</option>
                                        <option value="initial_fund" ${transactionData.paymentType === 'initial_fund' ? 'selected' : ''}>Initial Fund</option>
                                        <option value="due_clearance" ${transactionData.paymentType === 'due_clearance' ? 'selected' : ''}>Due Clearance</option>
                                        <option value="other" ${transactionData.paymentType === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Amount (Taka)</label>
                                    <input type="number" id="editAmount" value="${transactionData.amount || 0}" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Month</label>
                                <input type="month" id="editMonth" value="${transactionData.month || ''}" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Payment Date</label>
                                <input type="date" id="editDate" value="${transactionData.paymentDate || new Date().toISOString().slice(0,10)}" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Description</label>
                                <textarea id="editDescription" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" rows="3">${transactionData.description || ''}</textarea>
                            </div>
                        </div>
                    `;
                } else if (transactionType === 'expense') {
                    formHTML = `
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Expense Category</label>
                                    <select id="editCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500">
                                        <option value="office" ${transactionData.category === 'office' ? 'selected' : ''}>Office Supplies</option>
                                        <option value="bank" ${transactionData.category === 'bank' ? 'selected' : ''}>Bank Charges</option>
                                        <option value="transport" ${transactionData.category === 'transport' ? 'selected' : ''}>Transportation</option>
                                        <option value="food" ${transactionData.category === 'food' ? 'selected' : ''}>Food & Refreshments</option>
                                        <option value="maintenance" ${transactionData.category === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                        <option value="other" ${transactionData.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Amount (Taka)</label>
                                    <input type="number" id="editAmount" value="${transactionData.amount || 0}" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Expense Date</label>
                                <input type="date" id="editDate" value="${transactionData.expenseDate || new Date().toISOString().slice(0,10)}" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" required>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Description</label>
                                <textarea id="editDescription" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" rows="3">${transactionData.description || ''}</textarea>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Receipt/Proof</label>
                                <input type="text" id="editReceipt" value="${transactionData.receipt || ''}" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500">
                            </div>
                        </div>
                    `;
                }
                
                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-blue-600">‚úèÔ∏è</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Edit Transaction</h3>
                                <p class="text-gray-600">Update transaction details</p>
                            </div>
                            
                            <form onsubmit="updateTransaction(event, '${transactionId}', '${collectionName}', '${transactionType}', ${transactionData.amount || 0})" class="space-y-4">
                                ${formHTML}
                                
                                <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                                    Update Transaction
                                </button>
                            </form>

                            <button onclick="showRecentTransactions()" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading transaction for edit:', error);
                showError('Error loading transaction: ' + error.message);
            }
        }

        // Update transaction - FIXED to update member financial records correctly
        async function updateTransaction(e, transactionId, collectionName, transactionType, oldAmount) {
            e.preventDefault();
            showLoading();
            
            try {
                let updateData = {};
                let memberUpdateNeeded = false;
                let memberId = '';
                let amountDifference = 0;
                
                // Get current transaction data
                const transactionDoc = await db.collection(collectionName).doc(transactionId).get();
                const oldTransactionData = transactionDoc.data();
                
                if (transactionType === 'payment') {
                    memberId = oldTransactionData.memberId;
                    const newAmount = parseFloat(document.getElementById('editAmount').value);
                    amountDifference = newAmount - oldAmount;
                    const newPaymentType = document.getElementById('editPaymentType').value;
                    const oldPaymentType = oldTransactionData.paymentType;
                    
                    updateData = {
                        paymentType: newPaymentType,
                        amount: newAmount,
                        month: document.getElementById('editMonth').value,
                        paymentDate: document.getElementById('editDate').value,
                        description: document.getElementById('editDescription').value,
                        updatedAt: new Date()
                    };
                    
                    memberUpdateNeeded = true;
                    
                    // Update member's financial records
                    if (memberId) {
                        const memberDoc = await db.collection('users').doc(memberId).get();
                        const memberData = memberDoc.data();
                        
                        // Reverse old payment type effect
                        if (oldPaymentType === 'advance') {
                            // Subtract old advance
                            await db.collection('users').doc(memberId).update({
                                advance: firebase.firestore.FieldValue.increment(-oldAmount)
                            });
                        } else if (oldPaymentType === 'due_clearance') {
                            // Add back old due
                            await db.collection('users').doc(memberId).update({
                                due: firebase.firestore.FieldValue.increment(oldAmount)
                            });
                        } else {
                            // Subtract old total paid (for monthly, initial_fund, etc.)
                            await db.collection('users').doc(memberId).update({
                                totalPaid: firebase.firestore.FieldValue.increment(-oldAmount)
                            });
                        }
                        
                        // Apply new payment type effect
                        if (newPaymentType === 'advance') {
                            await db.collection('users').doc(memberId).update({
                                advance: firebase.firestore.FieldValue.increment(newAmount)
                            });
                        } else if (newPaymentType === 'due_clearance') {
                            await db.collection('users').doc(memberId).update({
                                due: firebase.firestore.FieldValue.increment(-newAmount)
                            });
                        } else {
                            await db.collection('users').doc(memberId).update({
                                totalPaid: firebase.firestore.FieldValue.increment(newAmount)
                            });
                        }
                    }
                } else if (transactionType === 'expense') {
                    updateData = {
                        category: document.getElementById('editCategory').value,
                        amount: parseFloat(document.getElementById('editAmount').value),
                        expenseDate: document.getElementById('editDate').value,
                        description: document.getElementById('editDescription').value,
                        receipt: document.getElementById('editReceipt').value,
                        updatedAt: new Date()
                    };
                }
                
                // Update the transaction
                await db.collection(collectionName).doc(transactionId).update(updateData);
                
                hideModals();
                hideLoading();
                showSuccess('Transaction updated successfully!');
                
                // Refresh the transactions list
                setTimeout(() => {
                    showRecentTransactions();
                }, 1500);
                
            } catch (error) {
                hideLoading();
                console.error('Error updating transaction:', error);
                showError('Error updating transaction: ' + error.message);
            }
        }

        // Delete transaction
        async function deleteTransaction(transactionId, collectionName) {
            if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                showLoading();
                
                try {
                    // Get transaction data first to update member records
                    const transactionDoc = await db.collection(collectionName).doc(transactionId).get();
                    const transactionData = transactionDoc.data();
                    
                    // Update member's financial records if it's a payment
                    if (collectionName === 'contributions' && transactionData.memberId) {
                        const paymentType = transactionData.paymentType;
                        const amount = transactionData.amount || 0;
                        
                        if (paymentType === 'advance') {
                            await db.collection('users').doc(transactionData.memberId).update({
                                advance: firebase.firestore.FieldValue.increment(-amount)
                            });
                        } else if (paymentType === 'due_clearance') {
                            await db.collection('users').doc(transactionData.memberId).update({
                                due: firebase.firestore.FieldValue.increment(amount)
                            });
                        } else {
                            await db.collection('users').doc(transactionData.memberId).update({
                                totalPaid: firebase.firestore.FieldValue.increment(-amount)
                            });
                        }
                    }
                    
                    // Delete the transaction
                    await db.collection(collectionName).doc(transactionId).delete();
                    
                    hideModals();
                    hideLoading();
                    showSuccess('Transaction deleted successfully!');
                    
                    // Refresh the transactions list
                    setTimeout(() => {
                        showRecentTransactions();
                    }, 1500);
                    
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting transaction:', error);
                    showError('Error deleting transaction: ' + error.message);
                }
            }
        }

        // Member Management
        async function showMemberManagement() {
            try {
                const membersSnapshot = await db.collection('users')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                
                let membersHTML = '';
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    const isCurrentUser = currentUser && doc.id === currentUser.uid;
                    membersHTML += `
                        <div class="member-row flex justify-between items-center p-4 bg-white rounded-xl border-2 border-gray-200 mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${member.name} ${member.role === 'admin' ? 'üëë' : ''}</h4>
                                <p class="text-sm text-gray-600">${member.email} ‚Ä¢ ${member.role}</p>
                                <p class="text-sm text-gray-500">
                                    Total Paid: ${member.totalPaid || 0} Tk ‚Ä¢ 
                                    Advance: ${member.advance || 0} Tk ‚Ä¢ 
                                    Due: ${member.due || 0} Tk
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editMember('${doc.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700">Edit</button>
                                <button onclick="resetMemberPassword('${doc.id}')" class="bg-orange-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-700">Reset Password</button>
                                ${!isCurrentUser && member.role !== 'admin' ? `
                                    <button onclick="deleteMember('${doc.id}')" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700">Remove</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-green-600">üë•</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Manage Members</h3>
                                <p class="text-gray-600">Add, edit, or remove committee members</p>
                            </div>
                            
                            <!-- Add Member Form -->
                            <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 mb-6">
                                <h4 class="font-semibold text-blue-800 mb-3 text-lg">Add New Member</h4>
                                <form onsubmit="addNewMember(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Full Name</label>
                                        <input type="text" id="newMemberName" placeholder="Enter full name" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Email</label>
                                        <input type="email" id="newMemberEmail" placeholder="Enter email" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <button type="submit" class="w-full btn-primary p-3">Add Member</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Members List -->
                            <div class="bg-white rounded-xl border-2 border-gray-200 p-4">
                                <h4 class="font-semibold text-gray-800 mb-4 text-lg">Current Members (${membersSnapshot.size})</h4>
                                <div class="max-h-96 overflow-y-auto">
                                    ${membersHTML || '<p class="text-center text-gray-500 py-4">No members found</p>'}
                                </div>
                            </div>

                            <button onclick="hideModals()" class="w-full mt-6 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading members:', error);
                showError('Error loading members: ' + error.message);
            }
        }

        // Add New Member
        async function addNewMember(e) {
            e.preventDefault();
            showLoading();
            
            const name = document.getElementById('newMemberName').value.trim();
            const email = document.getElementById('newMemberEmail').value.trim().toLowerCase();

            try {
                // Create a temporary password
                const tempPassword = Math.random().toString(36).slice(-8);
                
                // Create user with Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, tempPassword);
                const user = userCredential.user;

                // Update profile
                await user.updateProfile({ displayName: name });

                // Send email verification
                await user.sendEmailVerification();

                // Create user document
                const userData = {
                    name: name,
                    committeeName: currentCommitteeName,
                    email: email,
                    role: 'member',
                    joinDate: new Date(),
                    status: 'active',
                    societyId: currentSocietyId,
                    createdAt: new Date(),
                    userId: user.uid,
                    totalPaid: 0,
                    advance: 0,
                    due: 0,
                    emailVerified: false
                };

                await db.collection('users').doc(user.uid).set(userData);

                // Update committee members count
                const committeeRef = db.collection('committees').doc(currentSocietyId);
                await committeeRef.update({
                    totalMembers: firebase.firestore.FieldValue.increment(1),
                    members: firebase.firestore.FieldValue.arrayUnion({
                        userId: user.uid,
                        name: name,
                        email: email,
                        role: 'member',
                        joinDate: new Date()
                    })
                });

                hideModals();
                hideLoading();
                showSuccess(`Member ${name} added successfully!<br>
                    Temporary password: <code>${tempPassword}</code><br>
                    They should change it after first login.<br><br>
                    üìß <strong>Email verification sent to ${email}</strong>`);
                
                // Refresh member management
                setTimeout(() => {
                    showMemberManagement();
                }, 2000);

            } catch (error) {
                hideLoading();
                console.error('Error adding member:', error);
                showError('Error adding member: ' + error.message);
            }
        }

        // Edit Member
        async function editMember(memberId) {
            try {
                const memberDoc = await db.collection('users').doc(memberId).get();
                const member = memberDoc.data();
                
                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-blue-600">‚úèÔ∏è</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Edit Member</h3>
                                <p class="text-gray-600">Update member information</p>
                            </div>
                            
                            <form onsubmit="updateMember(event, '${memberId}')" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Full Name</label>
                                    <input type="text" id="editMemberName" value="${member.name || ''}" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Email</label>
                                    <input type="email" id="editMemberEmail" value="${member.email || ''}" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Total Paid (Tk)</label>
                                        <input type="number" id="editMemberTotalPaid" value="${member.totalPaid || 0}" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Advance (Tk)</label>
                                        <input type="number" id="editMemberAdvance" value="${member.advance || 0}" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Due (Tk)</label>
                                        <input type="number" id="editMemberDue" value="${member.due || 0}" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Role</label>
                                    <select id="editMemberRole" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                        <option value="member" ${member.role === 'member' ? 'selected' : ''}>Member</option>
                                        <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Status</label>
                                    <select id="editMemberStatus" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                        <option value="active" ${member.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${member.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>

                                <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                                    Update Member
                                </button>
                            </form>

                            <button onclick="showMemberManagement()" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading member for edit:', error);
                showError('Error loading member: ' + error.message);
            }
        }

        // Update Member
        async function updateMember(e, memberId) {
            e.preventDefault();
            showLoading();
            
            try {
                const updateData = {
                    name: document.getElementById('editMemberName').value.trim(),
                    email: document.getElementById('editMemberEmail').value.trim().toLowerCase(),
                    totalPaid: parseFloat(document.getElementById('editMemberTotalPaid').value) || 0,
                    advance: parseFloat(document.getElementById('editMemberAdvance').value) || 0,
                    due: parseFloat(document.getElementById('editMemberDue').value) || 0,
                    role: document.getElementById('editMemberRole').value,
                    status: document.getElementById('editMemberStatus').value,
                    updatedAt: new Date()
                };
                
                await db.collection('users').doc(memberId).update(updateData);
                
                hideModals();
                hideLoading();
                showSuccess('Member updated successfully!');
                
                // Refresh member management
                setTimeout(() => {
                    showMemberManagement();
                }, 1500);
                
            } catch (error) {
                hideLoading();
                console.error('Error updating member:', error);
                showError('Error updating member: ' + error.message);
            }
        }

        // Delete Member
        async function deleteMember(memberId) {
            const memberDoc = await db.collection('users').doc(memberId).get();
            const member = memberDoc.data();
            
            if (confirm(`Are you sure you want to remove ${member.name} from the committee?`)) {
                showLoading();
                
                try {
                    // Delete user from Firebase Auth if possible
                    try {
                        const user = await auth.getUserByEmail(member.email);
                        if (user) {
                            // Note: This requires admin privileges. You may need to handle this differently.
                            // For now, we'll just delete the Firestore document.
                        }
                    } catch (authError) {
                        console.log('Cannot delete auth user:', authError);
                    }
                    
                    // Delete user document
                    await db.collection('users').doc(memberId).delete();
                    
                    // Update committee members count
                    const committeeRef = db.collection('committees').doc(currentSocietyId);
                    await committeeRef.update({
                        totalMembers: firebase.firestore.FieldValue.increment(-1)
                    });
                    
                    hideModals();
                    hideLoading();
                    showSuccess('Member removed successfully!');
                    
                    // Refresh member management
                    setTimeout(() => {
                        showMemberManagement();
                    }, 1500);
                    
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting member:', error);
                    showError('Error deleting member: ' + error.message);
                }
            }
        }

        // Expense Management
        async function showExpenseManagement() {
            const modal = document.getElementById('featureModals');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-4 text-red-600">üì§</div>
                            <h3 class="text-3xl font-bold text-gray-800 mb-2">Expense Entry</h3>
                            <p class="text-gray-600">Record committee expenses</p>
                        </div>
                        
                        <form onsubmit="recordExpense(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Expense Category</label>
                                    <select id="expenseCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" required>
                                        <option value="office">Office Supplies</option>
                                        <option value="bank">Bank Charges</option>
                                        <option value="transport">Transportation</option>
                                        <option value="food">Food & Refreshments</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Amount (Taka)</label>
                                    <input type="number" id="expenseAmount" placeholder="Enter amount" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Expense Date</label>
                                <input type="date" id="expenseDate" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" required>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Description</label>
                                <textarea id="expenseDescription" placeholder="Expense description..." 
                                          class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500" rows="3" required></textarea>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Receipt/Proof</label>
                                <input type="text" id="expenseReceipt" placeholder="Receipt number or details" 
                                       class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500">
                            </div>

                            <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                                Record Expense
                            </button>
                        </form>

                        <button onclick="hideModals()" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                </div>
            `;

            // Set default date
            document.getElementById('expenseDate').value = new Date().toISOString().slice(0, 10);
        }

        // Record Expense
        async function recordExpense(e) {
            e.preventDefault();
            showLoading();

            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDate = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;
            const receipt = document.getElementById('expenseReceipt').value;

            try {
                const expenseData = {
                    societyId: currentSocietyId,
                    category: category,
                    amount: amount,
                    expenseDate: expenseDate,
                    description: description,
                    receipt: receipt,
                    recordedBy: currentUser.uid,
                    recordedAt: new Date()
                };

                await db.collection('expenses').add(expenseData);

                hideModals();
                hideLoading();
                showSuccess(`Expense of ${amount} Taka recorded successfully!`);

                // Refresh recent transactions
                loadRecentTransactions();

            } catch (error) {
                hideLoading();
                console.error('Error recording expense:', error);
                showError('Error recording expense: ' + error.message);
            }
        }

        // Penalty Management
        async function showPenaltyManagement() {
            try {
                const membersSnapshot = await db.collection('users')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                
                let membersOptions = '';
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    membersOptions += `<option value="${doc.id}">${member.name} (Due: ${member.due || 0} Tk)</option>`;
                });

                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-orange-600">‚ö°</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Manage Penalty</h3>
                                <p class="text-gray-600">Add late fees and penalties</p>
                            </div>
                            
                            <form onsubmit="recordPenalty(event)" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Select Member</label>
                                    <select id="penaltyMember" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500" required>
                                        <option value="">Choose a member</option>
                                        ${membersOptions}
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Penalty Type</label>
                                        <select id="penaltyType" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500" required>
                                            <option value="late_fee">Late Payment Fee</option>
                                            <option value="other_penalty">Other Penalty</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Amount (Taka)</label>
                                        <input type="number" id="penaltyAmount" placeholder="Enter penalty amount" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500" required>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">For Month</label>
                                    <input type="month" id="penaltyMonth" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500" required>
                                </div>

                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Reason</label>
                                    <textarea id="penaltyReason" placeholder="Reason for penalty..." 
                                              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500" rows="3" required></textarea>
                                </div>

                                <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                                    Record Penalty
                                </button>
                            </form>

                            <button onclick="hideModals()" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                // Set default month
                document.getElementById('penaltyMonth').value = new Date().toISOString().slice(0, 7);

            } catch (error) {
                console.error('Error loading penalty form:', error);
                showError('Error loading penalty form: ' + error.message);
            }
        }

        // Record Penalty
        async function recordPenalty(e) {
            e.preventDefault();
            showLoading();

            const memberId = document.getElementById('penaltyMember').value;
            const penaltyType = document.getElementById('penaltyType').value;
            const amount = parseFloat(document.getElementById('penaltyAmount').value);
            const month = document.getElementById('penaltyMonth').value;
            const reason = document.getElementById('penaltyReason').value;

            try {
                // Get member data
                const memberDoc = await db.collection('users').doc(memberId).get();
                const member = memberDoc.data();

                // Create penalty record
                const penaltyData = {
                    societyId: currentSocietyId,
                    memberId: memberId,
                    memberName: member.name,
                    penaltyType: penaltyType,
                    amount: amount,
                    month: month,
                    reason: reason,
                    recordedBy: currentUser.uid,
                    recordedAt: new Date()
                };

                await db.collection('penalties').add(penaltyData);

                // Update member's due amount
                await db.collection('users').doc(memberId).update({
                    due: firebase.firestore.FieldValue.increment(amount)
                });

                hideModals();
                hideLoading();
                showSuccess(`Penalty of ${amount} Taka recorded for ${member.name}!`);

            } catch (error) {
                hideLoading();
                console.error('Error recording penalty:', error);
                showError('Error recording penalty: ' + error.message);
            }
        }

        // Enhanced Payment Management with Advance Adjustment - FIXED
        async function showPaymentManagement() {
            try {
                const membersSnapshot = await db.collection('users')
                    .where('societyId', '==', currentSocietyId)
                    .get();
                
                const committeeDoc = await db.collection('committees').doc(currentSocietyId).get();
                const committeeData = committeeDoc.data();
                const monthlyAmount = committeeData.monthlyContribution || 1100;

                let membersOptions = '';
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    const advanceText = member.advance > 0 ? ` (Advance: ${member.advance} Tk)` : '';
                    membersOptions += `<option value="${doc.id}" data-advance="${member.advance || 0}">${member.name}${advanceText}</option>`;
                });

                const modal = document.getElementById('featureModals');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-4 text-blue-600">üí∞</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-2">Payment Entry</h3>
                                <p class="text-gray-600">Record member payments with advance adjustment</p>
                            </div>
                            
                            <!-- Advance Balance Info -->
                            <div id="advanceInfo" class="bg-green-50 p-4 rounded-xl border-2 border-green-200 mb-4 hidden">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-green-800">Advance Balance Available</h4>
                                        <p class="text-green-600" id="advanceBalanceText">0 Taka</p>
                                    </div>
                                    <div>
                                        <button type="button" onclick="useAdvanceForPayment()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                            Use Advance
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <form onsubmit="recordPayment(event)" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Select Member</label>
                                    <select id="paymentMember" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required onchange="checkAdvanceBalance()">
                                        <option value="">Choose a member</option>
                                        ${membersOptions}
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Payment Type</label>
                                        <select id="paymentType" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required onchange="handlePaymentTypeChange()">
                                            <option value="monthly">Monthly Contribution</option>
                                            <option value="advance">Advance Payment</option>
                                            <option value="initial_fund">Initial Fund</option>
                                            <option value="due_clearance">Due Clearance</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-semibold">Amount (Taka)</label>
                                        <input type="number" id="paymentAmount" placeholder="Enter amount" 
                                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Month</label>
                                    <input type="month" id="paymentMonth" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                </div>

                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Payment Date</label>
                                    <input type="date" id="paymentDate" 
                                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                </div>

                                <div>
                                    <label class="block text-gray-700 mb-2 font-semibold">Description</label>
                                    <textarea id="paymentDescription" placeholder="Payment description..." 
                                              class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                                </div>

                                <!-- Auto Adjustment Option -->
                                <div id="autoAdjustSection" class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 hidden">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" id="autoAdjustAdvance" class="w-5 h-5 text-blue-600">
                                        <label for="autoAdjustAdvance" class="text-blue-800 font-semibold">
                                            Automatically adjust future payments from advance balance
                                        </label>
                                    </div>
                                    <p class="text-sm text-blue-600 mt-2">
                                        When enabled, system will automatically use advance balance for future monthly payments
                                    </p>
                                </div>

                                <button type="submit" class="w-full btn-primary p-4 text-lg font-semibold rounded-xl">
                                    Record Payment
                                </button>
                            </form>

                            <button onclick="hideModals()" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-xl hover:bg-gray-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                // Set default values
                const currentDate = new Date();
                document.getElementById('paymentMonth').value = currentDate.toISOString().slice(0, 7);
                document.getElementById('paymentDate').value = currentDate.toISOString().slice(0, 10);
                document.getElementById('paymentAmount').value = monthlyAmount;

            } catch (error) {
                console.error('Error loading payment form:', error);
                showError('Error loading payment form: ' + error.message);
            }
        }

        // Check advance balance when member is selected
        function checkAdvanceBalance() {
            const memberSelect = document.getElementById('paymentMember');
            const selectedOption = memberSelect.options[memberSelect.selectedIndex];
            const advanceBalance = selectedOption.getAttribute('data-advance') || 0;
            
            const advanceInfo = document.getElementById('advanceInfo');
            const advanceBalanceText = document.getElementById('advanceBalanceText');
            
            if (advanceBalance > 0) {
                advanceInfo.classList.remove('hidden');
                advanceBalanceText.textContent = `${advanceBalance} Taka`;
            } else {
                advanceInfo.classList.add('hidden');
            }
        }

        // Use advance for payment
        function useAdvanceForPayment() {
            const memberSelect = document.getElementById('paymentMember');
            const selectedOption = memberSelect.options[memberSelect.selectedIndex];
            const advanceBalance = parseFloat(selectedOption.getAttribute('data-advance') || 0);
            const amountInput = document.getElementById('paymentAmount');
            
            if (advanceBalance > 0) {
                // Set the payment amount to whatever the user entered
                const currentAmount = parseFloat(amountInput.value) || 0;
                
                // Calculate how much advance to use
                const advanceToUse = Math.min(advanceBalance, currentAmount);
                
                if (advanceToUse > 0) {
                    // Update the amount field
                    amountInput.value = currentAmount - advanceToUse;
                    
                    // Update description
                    const descriptionField = document.getElementById('paymentDescription');
                    const currentDesc = descriptionField.value || '';
                    descriptionField.value = `${currentDesc} ${advanceToUse} Tk adjusted from advance.`.trim();
                    
                    // Show success message
                    const advanceInfo = document.getElementById('advanceInfo');
                    advanceInfo.innerHTML = `
                        <div class="bg-green-100 border-2 border-green-300 p-3 rounded-lg">
                            <p class="text-green-800 font-semibold">‚úÖ Advance adjustment applied</p>
                            <p class="text-green-600 text-sm">Advance used: ${advanceToUse} Tk | Remaining Advance: ${advanceBalance - advanceToUse} Tk</p>
                        </div>
                    `;
                }
            } else {
                alert('No advance balance available.');
            }
        }

        // Handle payment type changes
        function handlePaymentTypeChange() {
            const paymentType = document.getElementById('paymentType').value;
            const autoAdjustSection = document.getElementById('autoAdjustSection');
            
            if (paymentType === 'advance') {
                autoAdjustSection.classList.remove('hidden');
            } else {
                autoAdjustSection.classList.add('hidden');
            }
        }

        // Enhanced Record Payment function with advance adjustment - FIXED
        async function recordPayment(e) {
            e.preventDefault();
            showLoading();

            const memberId = document.getElementById('paymentMember').value;
            const paymentType = document.getElementById('paymentType').value;
            let amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const month = document.getElementById('paymentMonth').value;
            const paymentDate = document.getElementById('paymentDate').value;
            let description = document.getElementById('paymentDescription').value;
            const autoAdjustAdvance = document.getElementById('autoAdjustAdvance')?.checked || false;

            try {
                // Get member data
                const memberDoc = await db.collection('users').doc(memberId).get();
                const member = memberDoc.data();

                // Check if advance adjustment is mentioned in description
                let adjustedFromAdvance = 0;
                if (description && description.includes('adjusted from advance')) {
                    // Extract advance amount from description
                    const advanceMatch = description.match(/(\d+) Tk adjusted from advance/);
                    if (advanceMatch) {
                        adjustedFromAdvance = parseFloat(advanceMatch[1]);
                    }
                }

                // Create payment record
                const paymentData = {
                    societyId: currentSocietyId,
                    memberId: memberId,
                    memberName: member.name,
                    paymentType: paymentType,
                    amount: amount,
                    month: month,
                    paymentDate: paymentDate,
                    description: description,
                    recordedBy: currentUser.uid,
                    recordedAt: new Date(),
                    adjustedFromAdvance: adjustedFromAdvance > 0,
                    advanceAdjustmentAmount: adjustedFromAdvance,
                    autoAdjustEnabled: autoAdjustAdvance
                };

                await db.collection('contributions').add(paymentData);

                // Update member's financial data - FIXED: Advance payments don't add to totalPaid
                let updateData = {};
                
                switch (paymentType) {
                    case 'advance':
                        // Advance payment: only increase advance balance
                        updateData.advance = firebase.firestore.FieldValue.increment(amount);
                        break;
                    case 'due_clearance':
                        // Due clearance: decrease due, doesn't affect totalPaid
                        updateData.due = firebase.firestore.FieldValue.increment(-amount);
                        break;
                    default:
                        // Monthly contribution, initial_fund, etc.
                        if (adjustedFromAdvance > 0) {
                            // If adjusted from advance: decrease advance, increase totalPaid
                            updateData.advance = firebase.firestore.FieldValue.increment(-adjustedFromAdvance);
                            updateData.totalPaid = firebase.firestore.FieldValue.increment(amount);
                        } else {
                            // Regular payment: increase totalPaid
                            updateData.totalPaid = firebase.firestore.FieldValue.increment(amount);
                        }
                }

                await db.collection('users').doc(memberId).update(updateData);

                // If auto-adjust is enabled, schedule future adjustments
                if (autoAdjustAdvance && paymentType === 'advance') {
                    await scheduleAutoAdjustments(memberId, amount);
                }

                hideModals();
                hideLoading();
                
                let successMessage = `Payment of ${amount} Taka recorded successfully for ${member.name}!`;
                if (adjustedFromAdvance > 0) {
                    successMessage = `Payment of ${amount} Taka recorded (${adjustedFromAdvance} Tk adjusted from advance) for ${member.name}!`;
                }
                if (autoAdjustAdvance) {
                    successMessage += ` Auto-adjustment enabled for future payments.`;
                }
                
                showSuccess(successMessage);

                // Refresh recent transactions
                loadRecentTransactions();

            } catch (error) {
                hideLoading();
                console.error('Error recording payment:', error);
                showError('Error recording payment: ' + error.message);
            }
        }

        // Schedule automatic adjustments for advance payments
        async function scheduleAutoAdjustments(memberId, totalAdvanceAmount) {
            try {
                const committeeDoc = await db.collection('committees').doc(currentSocietyId).get();
                const committeeData = committeeDoc.data();
                const monthlyAmount = committeeData.monthlyContribution || 1100;
                
                // Calculate how many months can be covered
                const monthsCovered = Math.floor(totalAdvanceAmount / monthlyAmount);
                
                if (monthsCovered > 0) {
                    const currentDate = new Date();
                    
                    for (let i = 1; i <= monthsCovered; i++) {
                        const futureMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
                        const monthString = futureMonth.toISOString().slice(0, 7);
                        
                        // Create scheduled adjustment record
                        const adjustmentData = {
                            societyId: currentSocietyId,
                            memberId: memberId,
                            scheduledMonth: monthString,
                            amount: monthlyAmount,
                            status: 'scheduled',
                            createdAt: new Date(),
                            type: 'auto_adjustment'
                        };
                        
                        await db.collection('scheduled_adjustments').add(adjustmentData);
                    }
                    
                    console.log(`Scheduled ${monthsCovered} auto-adjustments for member ${memberId}`);
                }
            } catch (error) {
                console.error('Error scheduling auto-adjustments:', error);
            }
        }
    </script>
</body>
</html>